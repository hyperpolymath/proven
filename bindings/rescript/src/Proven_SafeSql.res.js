// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Belt_Array from "rescript/lib/es6/belt_Array.js";
import * as Proven_Bitwise from "./Proven_Bitwise.res.js";

var dangerousKeywords = [
  "DROP",
  "DELETE",
  "TRUNCATE",
  "ALTER",
  "GRANT",
  "REVOKE",
  "EXEC",
  "EXECUTE",
  "SHUTDOWN",
  "CREATE USER",
  "DROP USER"
];

function escapeStringLiteral(value) {
  var escaped = value.replace(/'/g, "''").replace(/\\/g, "\\\\").replace(/\x00/g, "\\0").replace(/\n/g, "\\n").replace(/\r/g, "\\r").replace(/\x1a/g, "\\Z");
  return "'" + escaped + "'";
}

function byteToHex($$byte) {
  var hexChars = "0123456789ABCDEF";
  var high = hexChars.charAt(Proven_Bitwise.land(Proven_Bitwise.lsr($$byte, 4), 15));
  var low = hexChars.charAt(Proven_Bitwise.land($$byte, 15));
  return high + low;
}

function escapeBlobLiteral(value) {
  var hexParts = value.map(byteToHex);
  return "X'" + hexParts.join("") + "'";
}

function isValidIdentifierFirstChar(c) {
  var code = c.charCodeAt(0);
  if (code >= 65.0 && code <= 90.0 || code >= 97.0 && code <= 122.0) {
    return true;
  } else {
    return code === 95.0;
  }
}

function isValidIdentifierChar(c) {
  var code = c.charCodeAt(0);
  if (code >= 48.0 && code <= 57.0 || code >= 65.0 && code <= 90.0 || code >= 97.0 && code <= 122.0) {
    return true;
  } else {
    return code === 95.0;
  }
}

function escapeIdentifier(identifier) {
  var length = identifier.length;
  if (length === 0) {
    return {
            TAG: "Error",
            _0: "InvalidIdentifier"
          };
  }
  var firstChar = identifier.charAt(0);
  if (!isValidIdentifierFirstChar(firstChar)) {
    return {
            TAG: "Error",
            _0: "InvalidIdentifier"
          };
  }
  var chars = identifier.split("");
  var allValid = chars.every(isValidIdentifierChar);
  if (allValid) {
    return {
            TAG: "Ok",
            _0: "\"" + identifier + "\""
          };
  } else {
    return {
            TAG: "Error",
            _0: "InvalidIdentifier"
          };
  }
}

function containsDangerousKeyword(query) {
  var upper = query.toUpperCase();
  return dangerousKeywords.some(function (keyword) {
              return upper.includes(keyword);
            });
}

function hasBalancedQuotes(query) {
  var length = query.length;
  var singleQuoteCount = 0;
  var doubleQuoteCount = 0;
  var inSingle = false;
  var inDouble = false;
  var prevChar = "";
  for(var i = 0; i < length; ++i){
    var c = query.charAt(i);
    if (c === "'" && prevChar !== "\\" && !inDouble) {
      inSingle = !inSingle;
      singleQuoteCount = singleQuoteCount + 1 | 0;
    } else if (c === "\"" && prevChar !== "\\" && !inSingle) {
      inDouble = !inDouble;
      doubleQuoteCount = doubleQuoteCount + 1 | 0;
    }
    prevChar = c;
  }
  if (singleQuoteCount % 2 === 0) {
    return doubleQuoteCount % 2 === 0;
  } else {
    return false;
  }
}

function escapeLikePattern(pattern, escapeChar) {
  var result = "";
  var length = pattern.length;
  for(var i = 0; i < length; ++i){
    var c = pattern.charAt(i);
    if (c === "%" || c === "_" || c === escapeChar) {
      result = result + escapeChar;
    }
    result = result + c;
  }
  return result;
}

function validateQuery(query) {
  if (query.length === 0) {
    return {
            TAG: "Error",
            _0: "EmptyQuery"
          };
  } else if (hasBalancedQuotes(query)) {
    return {
            TAG: "Ok",
            _0: undefined
          };
  } else {
    return {
            TAG: "Error",
            _0: "UnbalancedQuotes"
          };
  }
}

function isNull(value) {
  if (typeof value !== "object") {
    return true;
  } else {
    return false;
  }
}

function toSqlLiteral(value) {
  if (typeof value !== "object") {
    return "NULL";
  }
  switch (value.TAG) {
    case "SqlInteger" :
    case "SqlFloat" :
        return String(value._0);
    case "SqlText" :
        return escapeStringLiteral(value._0);
    case "SqlBlob" :
        return escapeBlobLiteral(value._0);
    case "SqlBoolean" :
        if (value._0) {
          return "TRUE";
        } else {
          return "FALSE";
        }
    
  }
}

function createQueryBuilder(style) {
  return {
          queryParts: [],
          parameters: [],
          placeholderStyle: style
        };
}

function addLiteral(builder, sql) {
  builder.queryParts = builder.queryParts.concat([sql]);
}

function addParam(builder, value) {
  if (builder.parameters.length >= 1000) {
    return {
            TAG: "Error",
            _0: "TooManyParameters"
          };
  } else {
    builder.parameters = builder.parameters.concat([value]);
    builder.queryParts = builder.queryParts.concat(["\x00"]);
    return {
            TAG: "Ok",
            _0: undefined
          };
  }
}

function buildQuery(builder) {
  var result = {
    contents: ""
  };
  var paramIndex = {
    contents: 1
  };
  builder.queryParts.forEach(function (part) {
        if (part !== "\x00") {
          result.contents = result.contents + part;
          return ;
        }
        var match = builder.placeholderStyle;
        var placeholder;
        switch (match) {
          case "QuestionMark" :
              placeholder = "?";
              break;
          case "DollarNumber" :
              placeholder = "$" + String(paramIndex.contents);
              break;
          case "AtName" :
              placeholder = "@p" + String(paramIndex.contents);
              break;
          case "ColonNumber" :
              placeholder = ":" + String(paramIndex.contents);
              break;
          
        }
        result.contents = result.contents + placeholder;
        paramIndex.contents = paramIndex.contents + 1 | 0;
      });
  return result.contents;
}

function getParameters(builder) {
  return builder.parameters;
}

function stripComments(query) {
  var result = "";
  var length = query.length;
  var i = 0;
  var inString = false;
  var stringChar = "";
  while(i < length) {
    var c = query.charAt(i);
    if (!inString && (c === "'" || c === "\"")) {
      inString = true;
      stringChar = c;
      result = result + c;
      i = i + 1 | 0;
    } else if (inString) {
      result = result + c;
      if (c === stringChar && (i === 0 || query.charAt(i - 1 | 0) !== "\\")) {
        inString = false;
      }
      i = i + 1 | 0;
    } else if ((i + 1 | 0) < length && c === "-" && query.charAt(i + 1 | 0) === "-") {
      while(i < length && query.charAt(i) !== "\n") {
        i = i + 1 | 0;
      };
    } else if ((i + 1 | 0) < length && c === "/" && query.charAt(i + 1 | 0) === "*") {
      i = i + 2 | 0;
      var foundClose = false;
      while((i + 1 | 0) < length && !foundClose) {
        if (query.charAt(i) === "*" && query.charAt(i + 1 | 0) === "/") {
          i = i + 2 | 0;
          foundClose = true;
        } else {
          i = i + 1 | 0;
        }
      };
    } else {
      result = result + c;
      i = i + 1 | 0;
    }
  };
  return result;
}

function selectQuery(table, columns, whereClause) {
  var e = escapeIdentifier(table);
  if (e.TAG !== "Ok") {
    return {
            TAG: "Error",
            _0: e._0
          };
  }
  var columnResults = columns.map(escapeIdentifier);
  var hasError = columnResults.some(function (r) {
        if (r.TAG === "Ok") {
          return false;
        } else {
          return true;
        }
      });
  if (hasError) {
    return {
            TAG: "Error",
            _0: "InvalidIdentifier"
          };
  }
  var escapedColumns = columnResults.map(function (r) {
        if (r.TAG === "Ok") {
          return r._0;
        } else {
          return "";
        }
      });
  var columnsStr = escapedColumns.length === 0 ? "*" : escapedColumns.join(", ");
  var query = "SELECT " + columnsStr + " FROM " + e._0;
  var finalQuery = whereClause !== undefined ? query + " WHERE " + whereClause : query;
  return {
          TAG: "Ok",
          _0: finalQuery
        };
}

function insertQuery(table, columns, style) {
  var e = escapeIdentifier(table);
  if (e.TAG !== "Ok") {
    return {
            TAG: "Error",
            _0: e._0
          };
  }
  var columnResults = columns.map(escapeIdentifier);
  var hasError = columnResults.some(function (r) {
        if (r.TAG === "Ok") {
          return false;
        } else {
          return true;
        }
      });
  if (hasError) {
    return {
            TAG: "Error",
            _0: "InvalidIdentifier"
          };
  }
  if (columns.length === 0) {
    return {
            TAG: "Error",
            _0: "EmptyQuery"
          };
  }
  var escapedColumns = columnResults.map(function (r) {
        if (r.TAG === "Ok") {
          return r._0;
        } else {
          return "";
        }
      });
  var columnsStr = escapedColumns.join(", ");
  var numCols = columns.length;
  var placeholders;
  switch (style) {
    case "QuestionMark" :
        placeholders = Belt_Array.make(numCols, "?").join(", ");
        break;
    case "DollarNumber" :
        placeholders = Belt_Array.mapWithIndex(Belt_Array.make(numCols, ""), (function (i, param) {
                  return "$" + String(i + 1 | 0);
                })).join(", ");
        break;
    case "AtName" :
        placeholders = Belt_Array.mapWithIndex(Belt_Array.make(numCols, ""), (function (i, param) {
                  return "@p" + String(i + 1 | 0);
                })).join(", ");
        break;
    case "ColonNumber" :
        placeholders = Belt_Array.mapWithIndex(Belt_Array.make(numCols, ""), (function (i, param) {
                  return ":" + String(i + 1 | 0);
                })).join(", ");
        break;
    
  }
  return {
          TAG: "Ok",
          _0: "INSERT INTO " + e._0 + " (" + columnsStr + ") VALUES (" + placeholders + ")"
        };
}

function updateQuery(table, columns, whereClause, style) {
  var e = escapeIdentifier(table);
  if (e.TAG !== "Ok") {
    return {
            TAG: "Error",
            _0: e._0
          };
  }
  if (columns.length === 0) {
    return {
            TAG: "Error",
            _0: "EmptyQuery"
          };
  }
  var setParts = {
    contents: []
  };
  var hasError = {
    contents: false
  };
  var paramIndex = {
    contents: 1
  };
  columns.forEach(function (col) {
        var escapedCol = escapeIdentifier(col);
        if (escapedCol.TAG !== "Ok") {
          hasError.contents = true;
          return ;
        }
        var placeholder;
        switch (style) {
          case "QuestionMark" :
              placeholder = "?";
              break;
          case "DollarNumber" :
              placeholder = "$" + String(paramIndex.contents);
              break;
          case "AtName" :
              placeholder = "@p" + String(paramIndex.contents);
              break;
          case "ColonNumber" :
              placeholder = ":" + String(paramIndex.contents);
              break;
          
        }
        setParts.contents = setParts.contents.concat([escapedCol._0 + " = " + placeholder]);
        paramIndex.contents = paramIndex.contents + 1 | 0;
      });
  if (hasError.contents) {
    return {
            TAG: "Error",
            _0: "InvalidIdentifier"
          };
  }
  var setStr = setParts.contents.join(", ");
  return {
          TAG: "Ok",
          _0: "UPDATE " + e._0 + " SET " + setStr + " WHERE " + whereClause
        };
}

function isSafeQuery(query) {
  if (hasBalancedQuotes(query)) {
    return !containsDangerousKeyword(query);
  } else {
    return false;
  }
}

function warnIfDangerous(query) {
  if (containsDangerousKeyword(query)) {
    return "Query contains potentially dangerous SQL keywords";
  }
  
}

var maxParameters = 1000;

export {
  maxParameters ,
  dangerousKeywords ,
  escapeStringLiteral ,
  byteToHex ,
  escapeBlobLiteral ,
  isValidIdentifierFirstChar ,
  isValidIdentifierChar ,
  escapeIdentifier ,
  containsDangerousKeyword ,
  hasBalancedQuotes ,
  escapeLikePattern ,
  validateQuery ,
  isNull ,
  toSqlLiteral ,
  createQueryBuilder ,
  addLiteral ,
  addParam ,
  buildQuery ,
  getParameters ,
  stripComments ,
  selectQuery ,
  insertQuery ,
  updateQuery ,
  isSafeQuery ,
  warnIfDangerous ,
}
/* No side effect */
