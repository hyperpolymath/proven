// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Belt_Array from "rescript/lib/es6/belt_Array.js";

var inlineEscapeChars = [
  /* '\\' */92,
  /* '`' */96,
  /* '*' */42,
  /* '_' */95,
  /* '[' */91,
  /* ']' */93,
  /* '(' */40,
  /* ')' */41,
  /* '<' */60,
  /* '>' */62,
  /* '|' */124,
  /* '~' */126
];

var lineStartEscapeChars = [
  /* '#' */35,
  /* '+' */43,
  /* '-' */45,
  /* '.' */46,
  /* '!' */33
];

function escapeInline(input) {
  var result = "";
  var inputLength = input.length;
  for(var i = 0; i < inputLength; ++i){
    var $$char = input.charAt(i);
    var shouldEscape = Belt_Array.some(inlineEscapeChars, (function($$char){
        return function (escapeChar) {
          return $$char === String(escapeChar);
        }
        }($$char)));
    result = shouldEscape ? result + "\\" + $$char : result + $$char;
  }
  return result;
}

function escapeLineStart(input) {
  var result = "";
  var atLineStart = true;
  var inputLength = input.length;
  for(var i = 0; i < inputLength; ++i){
    var $$char = input.charAt(i);
    if (atLineStart) {
      var shouldEscape = Belt_Array.some(lineStartEscapeChars, (function($$char){
          return function (escapeChar) {
            return $$char === String(escapeChar);
          }
          }($$char)));
      result = shouldEscape ? result + "\\" + $$char : result + $$char;
    } else {
      result = result + $$char;
    }
    atLineStart = $$char === "\n";
  }
  return result;
}

function escapeText(input) {
  return escapeLineStart(escapeInline(input));
}

function escapeLinkTitle(title) {
  return title.replace(/\\\\/g, "\\\\").replace(/\"/g, "\\\"").replace(/\\n/g, " ");
}

function escapeCodeSpan(code) {
  var maxBackticks = 0;
  var currentBackticks = 0;
  var codeLength = code.length;
  for(var i = 0; i < codeLength; ++i){
    var $$char = code.charAt(i);
    if ($$char === "`") {
      currentBackticks = currentBackticks + 1 | 0;
      if (currentBackticks > maxBackticks) {
        maxBackticks = currentBackticks;
      }
      
    } else {
      currentBackticks = 0;
    }
  }
  var fenceCount = maxBackticks + 1 | 0;
  var fence = "`".repeat(fenceCount);
  var startsWithBacktick = codeLength > 0 && code.charAt(0) === "`";
  var endsWithBacktick = codeLength > 0 && code.charAt(codeLength - 1 | 0) === "`";
  var prefix = startsWithBacktick ? " " : "";
  var suffix = endsWithBacktick ? " " : "";
  return fence + prefix + code + suffix + fence;
}

var dangerousProtocols = [
  "javascript:",
  "vbscript:",
  "data:",
  "file:"
];

function isValidLinkUrl(url) {
  if (url.length === 0) {
    return false;
  }
  var lowerUrl = url.toLowerCase();
  var hasDangerousProtocol = Belt_Array.some(dangerousProtocols, (function (protocol) {
          return lowerUrl.startsWith(protocol);
        }));
  if (hasDangerousProtocol) {
    return false;
  }
  var hasControlChars = false;
  var urlLength = url.length;
  for(var i = 0; i < urlLength; ++i){
    var charCode = url.charCodeAt(i) | 0;
    if (charCode < 32 || charCode === 127) {
      hasControlChars = true;
    }
    
  }
  return !hasControlChars;
}

function isValidImageUrl(url) {
  return isValidLinkUrl(url);
}

function sanitizeUrl(url) {
  if (isValidLinkUrl(url)) {
    return url.replace(/\\(/g, "%28").replace(/\\)/g, "%29").replace(/ /g, "%20");
  }
  
}

function createLink(text, url, title) {
  if (!isValidLinkUrl(url)) {
    return {
            TAG: "Error",
            _0: "InvalidLinkUrl"
          };
  }
  var escapedText = escapeInline(text);
  var sanitizedUrl = sanitizeUrl(url);
  if (sanitizedUrl === undefined) {
    return {
            TAG: "Error",
            _0: "InvalidLinkUrl"
          };
  }
  var titlePart = title !== undefined ? " \"" + escapeLinkTitle(title) + "\"" : "";
  return {
          TAG: "Ok",
          _0: "[" + escapedText + "](" + sanitizedUrl + titlePart + ")"
        };
}

function createImage(altText, url, title) {
  if (!isValidLinkUrl(url)) {
    return {
            TAG: "Error",
            _0: "InvalidImageUrl"
          };
  }
  var escapedAlt = escapeInline(altText);
  var sanitizedUrl = sanitizeUrl(url);
  if (sanitizedUrl === undefined) {
    return {
            TAG: "Error",
            _0: "InvalidImageUrl"
          };
  }
  var titlePart = title !== undefined ? " \"" + escapeLinkTitle(title) + "\"" : "";
  return {
          TAG: "Ok",
          _0: "![" + escapedAlt + "](" + sanitizedUrl + titlePart + ")"
        };
}

function stripFormatting(input) {
  var result = "";
  var inputLength = input.length;
  var index = 0;
  while(index < inputLength) {
    var $$char = input.charAt(index);
    if ($$char === "\\" && (index + 1 | 0) < inputLength) {
      result = result + input.charAt(index + 1 | 0);
      index = index + 2 | 0;
    } else {
      var skip;
      switch ($$char) {
        case "*" :
        case "_" :
        case "`" :
        case "~" :
            skip = true;
            break;
        default:
          skip = false;
      }
      if (!skip) {
        result = result + $$char;
      }
      index = index + 1 | 0;
    }
  };
  return result;
}

function hasFormatting(input) {
  var inputLength = input.length;
  var index = 0;
  var foundFormatting = false;
  while(index < inputLength && !foundFormatting) {
    var $$char = input.charAt(index);
    if ($$char === "\\" && (index + 1 | 0) < inputLength) {
      index = index + 2 | 0;
    } else {
      switch ($$char) {
        case "!" :
        case "#" :
        case "*" :
        case "[" :
        case "]" :
        case "_" :
        case "`" :
        case "|" :
        case "~" :
            foundFormatting = true;
            break;
        default:
          
      }
      index = index + 1 | 0;
    }
  };
  return foundFormatting;
}

function isValidUtf8(input) {
  return !/\\uFFFD/.test(input);
}

function detectBlockType(line) {
  var trimmed = line.trim();
  if (trimmed.length === 0) {
    return "Paragraph";
  }
  var firstChar = trimmed.charAt(0);
  if (firstChar === "#") {
    return "Heading";
  }
  if (trimmed.startsWith("```") || trimmed.startsWith("~~~")) {
    return "CodeBlock";
  }
  if (firstChar === ">") {
    return "Blockquote";
  }
  if (trimmed.length < 2) {
    return "Paragraph";
  }
  var secondChar = trimmed.charAt(1);
  if ((firstChar === "-" || firstChar === "*" || firstChar === "+") && secondChar === " ") {
    return "UnorderedList";
  } else if (firstChar >= "0" && firstChar <= "9") {
    if (/^\\d+\\. /.test(trimmed)) {
      return "OrderedList";
    } else {
      return "Paragraph";
    }
  } else if (/^[-*_]{3,}$/.test(trimmed.replace(/ /g, ""))) {
    return "HorizontalRule";
  } else if (firstChar === "|") {
    return "Table";
  } else {
    return "Paragraph";
  }
}

function errorToString(err) {
  switch (err) {
    case "InvalidUtf8" :
        return "Invalid UTF-8 sequence";
    case "NestingTooDeep" :
        return "Nesting depth exceeds maximum";
    case "UnclosedElement" :
        return "Unclosed Markdown element";
    case "InvalidLinkUrl" :
        return "Invalid or dangerous URL for link";
    case "InvalidImageUrl" :
        return "Invalid or dangerous URL for image";
    
  }
}

var maxNestingDepth = 16;

export {
  maxNestingDepth ,
  inlineEscapeChars ,
  lineStartEscapeChars ,
  escapeInline ,
  escapeLineStart ,
  escapeText ,
  escapeLinkTitle ,
  escapeCodeSpan ,
  dangerousProtocols ,
  isValidLinkUrl ,
  isValidImageUrl ,
  sanitizeUrl ,
  createLink ,
  createImage ,
  stripFormatting ,
  hasFormatting ,
  isValidUtf8 ,
  detectBlockType ,
  errorToString ,
}
/* No side effect */
