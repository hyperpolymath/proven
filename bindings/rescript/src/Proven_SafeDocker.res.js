// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Belt_Int from "rescript/lib/es6/belt_Int.js";
import * as Belt_Array from "rescript/lib/es6/belt_Array.js";
import * as Belt_Option from "rescript/lib/es6/belt_Option.js";

var Registry = {
  dockerHub: "docker.io",
  gcr: "gcr.io",
  ghcr: "ghcr.io",
  ecrPublic: "public.ecr.aws",
  quay: "quay.io",
  acr: "azurecr.io"
};

function isLowerAlnum($$char) {
  var code = $$char.charCodeAt(0) | 0;
  if (code >= 48 && code <= 57) {
    return true;
  } else if (code >= 97) {
    return code <= 122;
  } else {
    return false;
  }
}

function isAlnum($$char) {
  var code = $$char.charCodeAt(0) | 0;
  if (code >= 48 && code <= 57 || code >= 65 && code <= 90) {
    return true;
  } else if (code >= 97) {
    return code <= 122;
  } else {
    return false;
  }
}

function isValidRepositoryName(name) {
  var length = name.length;
  if (length === 0 || length > 256) {
    return false;
  }
  var firstChar = name.charAt(0);
  if (!isLowerAlnum(firstChar)) {
    return false;
  }
  var valid = true;
  var prevSeparator = false;
  for(var i = 0; i < length; ++i){
    if (valid) {
      var $$char = name.charAt(i);
      var isSeparator = $$char === "." || $$char === "_" || $$char === "-";
      var isAlnumLower = isLowerAlnum($$char);
      if (!isAlnumLower && !isSeparator || isSeparator && prevSeparator) {
        valid = false;
      }
      prevSeparator = isSeparator;
    }
    
  }
  if (valid) {
    var lastChar = name.charAt(length - 1 | 0);
    if (lastChar === "." || lastChar === "_" || lastChar === "-") {
      valid = false;
    }
    
  }
  return valid;
}

function isValidTag(tag) {
  var length = tag.length;
  if (length === 0 || length > 128) {
    return false;
  }
  var firstChar = tag.charAt(0);
  if (!isAlnum(firstChar) && firstChar !== "_") {
    return false;
  }
  var valid = true;
  for(var i = 0; i < length; ++i){
    if (valid) {
      var $$char = tag.charAt(i);
      if (!isAlnum($$char) && $$char !== "_" && $$char !== "-" && $$char !== ".") {
        valid = false;
      }
      
    }
    
  }
  return valid;
}

function isValidDigest(digest) {
  var colonPos = digest.indexOf(":");
  if (colonPos === -1) {
    return false;
  }
  var algorithm = digest.slice(0, colonPos);
  var hash = digest.slice(colonPos + 1 | 0);
  var validAlgorithm = algorithm === "sha256" || algorithm === "sha384" || algorithm === "sha512";
  if (!validAlgorithm) {
    return false;
  }
  var expectedLen;
  switch (algorithm) {
    case "sha256" :
        expectedLen = 64;
        break;
    case "sha384" :
        expectedLen = 96;
        break;
    default:
      expectedLen = 128;
  }
  var hashLen = hash.length;
  if (hashLen !== expectedLen) {
    return false;
  }
  var valid = true;
  for(var i = 0; i < hashLen; ++i){
    if (valid) {
      var $$char = hash.charAt(i);
      var code = $$char.charCodeAt(0) | 0;
      var isHex = code >= 48 && code <= 57 || code >= 65 && code <= 70 || code >= 97 && code <= 102;
      if (!isHex) {
        valid = false;
      }
      
    }
    
  }
  return valid;
}

function isValidContainerName(name) {
  var length = name.length;
  if (length === 0 || length > 63) {
    return false;
  }
  var firstChar = name.charAt(0);
  if (!isAlnum(firstChar)) {
    return false;
  }
  var valid = true;
  for(var i = 0; i < length; ++i){
    if (valid) {
      var $$char = name.charAt(i);
      if (!isAlnum($$char) && $$char !== "_" && $$char !== "." && $$char !== "-") {
        valid = false;
      }
      
    }
    
  }
  return valid;
}

function isValidRegistry(registry) {
  var length = registry.length;
  if (length === 0) {
    return false;
  }
  var colonPos = registry.lastIndexOf(":");
  var hostname;
  if (colonPos !== -1) {
    var portStr = registry.slice(colonPos + 1 | 0);
    var port = Belt_Int.fromString(portStr);
    hostname = port !== undefined && !(port <= 0 || port > 65535) ? registry.slice(0, colonPos) : "";
  } else {
    hostname = registry;
  }
  if (hostname.length === 0) {
    return false;
  }
  if (hostname !== "localhost" && !hostname.includes(".")) {
    return false;
  }
  var valid = true;
  var prevDot = false;
  var hostnameLen = hostname.length;
  for(var i = 0; i < hostnameLen; ++i){
    if (valid) {
      var $$char = hostname.charAt(i);
      var isDot = $$char === ".";
      var validChar = isAlnum($$char) || $$char === "-" || $$char === ".";
      if (!(validChar && !(isDot && prevDot))) {
        valid = false;
      }
      prevDot = isDot;
    }
    
  }
  if (valid) {
    var firstChar = hostname.charAt(0);
    var lastChar = hostname.charAt(hostnameLen - 1 | 0);
    if (firstChar === "." || firstChar === "-" || lastChar === "." || lastChar === "-") {
      valid = false;
    }
    
  }
  return valid;
}

function isValidNamespace(namespace) {
  var length = namespace.length;
  if (length === 0 || length > 255) {
    return false;
  }
  var firstChar = namespace.charAt(0);
  if (!isAlnum(firstChar)) {
    return false;
  }
  var valid = true;
  for(var i = 0; i < length; ++i){
    if (valid) {
      var $$char = namespace.charAt(i);
      if (!isAlnum($$char) && $$char !== "_" && $$char !== "-") {
        valid = false;
      }
      
    }
    
  }
  return valid;
}

function parseImageReference(input) {
  var length = input.length;
  if (length === 0) {
    return {
            TAG: "Error",
            _0: "InvalidImageName"
          };
  }
  var remaining = input;
  var digest;
  var tag;
  var atPos = remaining.indexOf("@");
  if (atPos !== -1) {
    var digestStr = remaining.slice(atPos + 1 | 0);
    if (isValidDigest(digestStr)) {
      digest = digestStr;
      remaining = remaining.slice(0, atPos);
    }
    
  }
  if (Belt_Option.isNone(digest)) {
    var colonPos = remaining.lastIndexOf(":");
    if (colonPos !== -1) {
      var afterColon = remaining.slice(colonPos + 1 | 0);
      if (!afterColon.includes("/") && afterColon.length > 0 && isValidTag(afterColon)) {
        tag = afterColon;
        remaining = remaining.slice(0, colonPos);
      }
      
    }
    
  }
  var parts = remaining.split("/");
  var partCount = parts.length;
  if (partCount === 0) {
    return {
            TAG: "Error",
            _0: "InvalidImageName"
          };
  }
  if (partCount === 1) {
    var repository = parts[0];
    if (isValidRepositoryName(repository)) {
      return {
              TAG: "Ok",
              _0: {
                registry: undefined,
                namespace: undefined,
                repository: repository,
                tag: tag,
                digest: digest
              }
            };
    } else {
      return {
              TAG: "Error",
              _0: "InvalidRepository"
            };
    }
  }
  if (partCount === 2) {
    var first = parts[0];
    var second = parts[1];
    if (first.includes(".") || first.includes(":") || first === "localhost") {
      if (isValidRegistry(first)) {
        if (isValidRepositoryName(second)) {
          return {
                  TAG: "Ok",
                  _0: {
                    registry: first,
                    namespace: undefined,
                    repository: second,
                    tag: tag,
                    digest: digest
                  }
                };
        } else {
          return {
                  TAG: "Error",
                  _0: "InvalidRepository"
                };
        }
      } else {
        return {
                TAG: "Error",
                _0: "InvalidRegistry"
              };
      }
    } else if (isValidNamespace(first)) {
      if (isValidRepositoryName(second)) {
        return {
                TAG: "Ok",
                _0: {
                  registry: undefined,
                  namespace: first,
                  repository: second,
                  tag: tag,
                  digest: digest
                }
              };
      } else {
        return {
                TAG: "Error",
                _0: "InvalidRepository"
              };
      }
    } else {
      return {
              TAG: "Error",
              _0: "InvalidNamespace"
            };
    }
  }
  var first$1 = parts[0];
  var registry;
  var namespace;
  if (isValidRegistry(first$1) || first$1 === "docker.io") {
    registry = first$1;
    if (partCount >= 3) {
      var ns = parts[1];
      if (isValidNamespace(ns)) {
        namespace = ns;
      }
      
    }
    
  } else if (isValidNamespace(first$1)) {
    namespace = first$1;
  }
  var repository$1 = parts[partCount - 1 | 0];
  if (isValidRepositoryName(repository$1)) {
    return {
            TAG: "Ok",
            _0: {
              registry: registry,
              namespace: namespace,
              repository: repository$1,
              tag: tag,
              digest: digest
            }
          };
  } else {
    return {
            TAG: "Error",
            _0: "InvalidRepository"
          };
  }
}

function isValidImageReference(input) {
  var match = parseImageReference(input);
  if (match.TAG === "Ok") {
    return true;
  } else {
    return false;
  }
}

function getFullName(imgRef) {
  var parts = [];
  var reg = imgRef.registry;
  if (reg !== undefined) {
    parts = Belt_Array.concat(parts, [reg]);
  }
  var ns = imgRef.namespace;
  if (ns !== undefined) {
    parts = Belt_Array.concat(parts, [ns]);
  }
  parts = Belt_Array.concat(parts, [imgRef.repository]);
  return parts.join("/");
}

function getFullReference(imgRef) {
  var name = getFullName(imgRef);
  var dig = imgRef.digest;
  if (dig !== undefined) {
    return name + "@" + dig;
  }
  var t = imgRef.tag;
  if (t !== undefined) {
    return name + ":" + t;
  } else {
    return name;
  }
}

function isOfficial(imgRef) {
  var reg = imgRef.registry;
  if (reg !== undefined && reg !== "docker.io" && reg !== "index.docker.io") {
    return false;
  }
  var ns = imgRef.namespace;
  if (ns !== undefined) {
    return ns === "library";
  } else {
    return true;
  }
}

function hasTag(imgRef) {
  return Belt_Option.isSome(imgRef.tag);
}

function isPinned(imgRef) {
  return Belt_Option.isSome(imgRef.digest);
}

function isLatest(imgRef) {
  if (Belt_Option.isSome(imgRef.digest)) {
    return false;
  }
  var t = imgRef.tag;
  if (t !== undefined) {
    return t === "latest";
  } else {
    return true;
  }
}

function normalizeImageReference(input) {
  var e = parseImageReference(input);
  if (e.TAG !== "Ok") {
    return {
            TAG: "Error",
            _0: e._0
          };
  }
  var ref = e._0;
  var r = ref.registry;
  var registry = r !== undefined ? r : "docker.io";
  var ns = ref.namespace;
  var namespace = ns !== undefined ? ns : "library";
  var dig = ref.digest;
  var tagOrDigest;
  if (dig !== undefined) {
    tagOrDigest = "@" + dig;
  } else {
    var t = ref.tag;
    tagOrDigest = t !== undefined ? ":" + t : ":latest";
  }
  return {
          TAG: "Ok",
          _0: registry + "/" + namespace + "/" + ref.repository + tagOrDigest
        };
}

function dockerErrorToString(error) {
  switch (error) {
    case "InvalidImageName" :
        return "Invalid image name";
    case "InvalidTag" :
        return "Invalid tag";
    case "InvalidDigest" :
        return "Invalid digest";
    case "InvalidRegistry" :
        return "Invalid registry";
    case "InvalidContainerName" :
        return "Invalid container name";
    case "InvalidRepository" :
        return "Invalid repository name";
    case "InvalidNamespace" :
        return "Invalid namespace";
    case "NameTooLong" :
        return "Name is too long";
    
  }
}

var maxImageNameLength = 128;

var maxTagLength = 128;

var maxContainerNameLength = 63;

var maxRepositoryLength = 256;

export {
  maxImageNameLength ,
  maxTagLength ,
  maxContainerNameLength ,
  maxRepositoryLength ,
  Registry ,
  isLowerAlnum ,
  isAlnum ,
  isValidRepositoryName ,
  isValidTag ,
  isValidDigest ,
  isValidContainerName ,
  isValidRegistry ,
  isValidNamespace ,
  parseImageReference ,
  isValidImageReference ,
  getFullName ,
  getFullReference ,
  isOfficial ,
  hasTag ,
  isPinned ,
  isLatest ,
  normalizeImageReference ,
  dockerErrorToString ,
}
/* No side effect */
