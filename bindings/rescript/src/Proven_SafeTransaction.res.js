// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Belt_Array from "rescript/lib/es6/belt_Array.js";

function isolationLevelToString(level) {
  switch (level) {
    case "ReadUncommitted" :
        return "READ UNCOMMITTED";
    case "ReadCommitted" :
        return "READ COMMITTED";
    case "RepeatableRead" :
        return "REPEATABLE READ";
    case "Serializable" :
        return "SERIALIZABLE";
    
  }
}

function isTerminal(state) {
  switch (state) {
    case "Idle" :
    case "Active" :
        return false;
    default:
      return true;
  }
}

function canOperate(state) {
  return state === "Active";
}

function createTransactionManager() {
  return {
          state: "Idle",
          isolationLevel: "ReadCommitted",
          operations: [],
          savepoints: [],
          startedAt: undefined,
          transactionId: 0,
          nextId: 1
        };
}

function begin(txn) {
  if (txn.state === "Active") {
    return {
            TAG: "Error",
            _0: "AlreadyInTransaction"
          };
  } else if (txn.state === "Failed") {
    return {
            TAG: "Error",
            _0: "RollbackRequired"
          };
  } else {
    txn.state = "Active";
    txn.isolationLevel = "ReadCommitted";
    txn.operations = [];
    txn.savepoints = [];
    txn.startedAt = Date.now();
    txn.transactionId = txn.nextId;
    txn.nextId = txn.nextId + 1 | 0;
    return {
            TAG: "Ok",
            _0: undefined
          };
  }
}

function beginWithIsolation(txn, level) {
  if (txn.state === "Active") {
    return {
            TAG: "Error",
            _0: "AlreadyInTransaction"
          };
  } else if (txn.state === "Failed") {
    return {
            TAG: "Error",
            _0: "RollbackRequired"
          };
  } else {
    txn.state = "Active";
    txn.isolationLevel = level;
    txn.operations = [];
    txn.savepoints = [];
    txn.startedAt = Date.now();
    txn.transactionId = txn.nextId;
    txn.nextId = txn.nextId + 1 | 0;
    return {
            TAG: "Ok",
            _0: undefined
          };
  }
}

function commit(txn) {
  if (txn.state !== "Active") {
    return {
            TAG: "Error",
            _0: "NotInTransaction"
          };
  } else {
    txn.state = "Committed";
    txn.startedAt = undefined;
    return {
            TAG: "Ok",
            _0: undefined
          };
  }
}

function rollback(txn) {
  if (txn.state !== "Active" && txn.state !== "Failed") {
    return {
            TAG: "Error",
            _0: "NotInTransaction"
          };
  } else {
    txn.state = "RolledBack";
    txn.startedAt = undefined;
    return {
            TAG: "Ok",
            _0: undefined
          };
  }
}

function createSavepoint(txn, name) {
  if (txn.state !== "Active") {
    return {
            TAG: "Error",
            _0: "NotInTransaction"
          };
  }
  if (txn.savepoints.length >= 32) {
    return {
            TAG: "Error",
            _0: "MaxSavepointsReached"
          };
  }
  var sp_operationIndex = txn.operations.length;
  var sp_createdAt = Date.now();
  var sp = {
    name: name,
    operationIndex: sp_operationIndex,
    createdAt: sp_createdAt
  };
  txn.savepoints = Belt_Array.concat(txn.savepoints, [sp]);
  return {
          TAG: "Ok",
          _0: undefined
        };
}

function rollbackToSavepoint(txn, name) {
  if (txn.state !== "Active") {
    return {
            TAG: "Error",
            _0: "NotInTransaction"
          };
  }
  var maybeIdx = Belt_Array.getIndexBy(txn.savepoints, (function (sp) {
          return sp.name === name;
        }));
  if (maybeIdx === undefined) {
    return {
            TAG: "Error",
            _0: "SavepointNotFound"
          };
  }
  var sp = txn.savepoints[maybeIdx];
  txn.operations = Belt_Array.slice(txn.operations, 0, sp.operationIndex);
  txn.savepoints = Belt_Array.slice(txn.savepoints, 0, maybeIdx);
  return {
          TAG: "Ok",
          _0: undefined
        };
}

function releaseSavepoint(txn, name) {
  if (txn.state !== "Active") {
    return {
            TAG: "Error",
            _0: "NotInTransaction"
          };
  }
  var maybeIdx = Belt_Array.getIndexBy(txn.savepoints, (function (sp) {
          return sp.name === name;
        }));
  if (maybeIdx === undefined) {
    return {
            TAG: "Error",
            _0: "SavepointNotFound"
          };
  }
  var before = Belt_Array.slice(txn.savepoints, 0, maybeIdx);
  var after = Belt_Array.sliceToEnd(txn.savepoints, maybeIdx + 1 | 0);
  txn.savepoints = Belt_Array.concat(before, after);
  return {
          TAG: "Ok",
          _0: undefined
        };
}

function recordOperation(txn, opType, key, oldValue, newValue) {
  if (txn.state !== "Active") {
    return {
            TAG: "Error",
            _0: "NotInTransaction"
          };
  }
  if (txn.operations.length >= 256) {
    txn.state = "Failed";
    return {
            TAG: "Error",
            _0: "InvalidState"
          };
  }
  var op_timestamp = Date.now();
  var op = {
    opType: opType,
    key: key,
    oldValue: oldValue,
    newValue: newValue,
    timestamp: op_timestamp
  };
  txn.operations = Belt_Array.concat(txn.operations, [op]);
  return {
          TAG: "Ok",
          _0: undefined
        };
}

function getState(txn) {
  return txn.state;
}

function isActive(txn) {
  return txn.state === "Active";
}

function getId(txn) {
  if (txn.state === "Active") {
    return txn.transactionId;
  } else {
    return 0;
  }
}

function getOperationCount(txn) {
  return txn.operations.length;
}

function getSavepointCount(txn) {
  return txn.savepoints.length;
}

function getIsolationLevel(txn) {
  return txn.isolationLevel;
}

function fail(txn) {
  if (txn.state === "Active") {
    txn.state = "Failed";
    return ;
  }
  
}

function resetState(txn) {
  txn.state = "Idle";
  txn.operations = [];
  txn.savepoints = [];
  txn.startedAt = undefined;
}

function createGuard(manager) {
  var e = begin(manager);
  if (e.TAG === "Ok") {
    return {
            TAG: "Ok",
            _0: {
              manager: manager,
              committed: false
            }
          };
  } else {
    return {
            TAG: "Error",
            _0: e._0
          };
  }
}

function commitGuard(guard) {
  var e = commit(guard.manager);
  if (e.TAG !== "Ok") {
    return {
            TAG: "Error",
            _0: e._0
          };
  }
  guard.committed = true;
  return {
          TAG: "Ok",
          _0: undefined
        };
}

function rollbackGuard(guard) {
  var e = rollback(guard.manager);
  if (e.TAG !== "Ok") {
    return {
            TAG: "Error",
            _0: e._0
          };
  }
  guard.committed = true;
  return {
          TAG: "Ok",
          _0: undefined
        };
}

function finalizeGuard(guard) {
  if (!guard.committed && guard.manager.state === "Active") {
    rollback(guard.manager);
    return ;
  }
  
}

function withTransaction(manager, f) {
  var e = begin(manager);
  if (e.TAG !== "Ok") {
    return {
            TAG: "Error",
            _0: e._0
          };
  }
  var result = f();
  if (result.TAG === "Ok") {
    var e$1 = commit(manager);
    if (e$1.TAG === "Ok") {
      return {
              TAG: "Ok",
              _0: result._0
            };
    }
    rollback(manager);
    return {
            TAG: "Error",
            _0: e$1._0
          };
  }
  rollback(manager);
  return {
          TAG: "Error",
          _0: "RollbackRequired"
        };
}

var maxSavepoints = 32;

var maxOperations = 256;

export {
  maxSavepoints ,
  maxOperations ,
  isolationLevelToString ,
  isTerminal ,
  canOperate ,
  createTransactionManager ,
  begin ,
  beginWithIsolation ,
  commit ,
  rollback ,
  createSavepoint ,
  rollbackToSavepoint ,
  releaseSavepoint ,
  recordOperation ,
  getState ,
  isActive ,
  getId ,
  getOperationCount ,
  getSavepointCount ,
  getIsolationLevel ,
  fail ,
  resetState ,
  createGuard ,
  commitGuard ,
  rollbackGuard ,
  finalizeGuard ,
  withTransaction ,
}
/* No side effect */
