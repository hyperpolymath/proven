# SPDX-License-Identifier: PMPL-1.0-or-later
name: ECHIDNA Proof Verification

permissions: read-all

on:
  push:
    branches: [main]
    paths:
      - 'src/**/*.idr'
      - 'proven.ipkg'
      - '.echidnabot.toml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**/*.idr'
      - 'proven.ipkg'
      - '.echidnabot.toml'
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    name: Verify Idris 2 Proofs

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Install Idris 2 dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chezscheme libgmp-dev

      - name: Cache Idris 2
        id: cache-idris2
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4
        with:
          path: |
            ~/.idris2
            ~/idris2-0.7.0
          key: idris2-0.7.0-${{ runner.os }}

      - name: Install Idris 2
        if: steps.cache-idris2.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch v0.7.0 https://github.com/idris-lang/Idris2.git ~/idris2-0.7.0
          cd ~/idris2-0.7.0
          make bootstrap SCHEME=chezscheme
          make install

      - name: Add Idris 2 to PATH
        run: echo "$HOME/.idris2/bin" >> $GITHUB_PATH

      - name: Build proven library
        run: idris2 --build proven.ipkg

      # Verify totality of all public functions
      - name: Verify totality proofs
        run: |
          echo "## Totality Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check each safety module for totality
          modules=(
            "src/Proven/SafeMath.idr"
            "src/Proven/SafeString.idr"
            "src/Proven/SafeJson.idr"
            "src/Proven/SafeUrl.idr"
            "src/Proven/SafeEmail.idr"
            "src/Proven/SafeUuid.idr"
            "src/Proven/SafeCurrency.idr"
            "src/Proven/SafePhone.idr"
            "src/Proven/SafeHex.idr"
            "src/Proven/SafeHeader.idr"
            "src/Proven/SafeCookie.idr"
            "src/Proven/SafeContentType.idr"
          )

          failed=0
          for module in "${modules[@]}"; do
            if [ -f "$module" ]; then
              echo "Checking $module..."
              if idris2 --check "$module" 2>&1; then
                echo "- ✓ $module" >> $GITHUB_STEP_SUMMARY
              else
                echo "- ✗ $module" >> $GITHUB_STEP_SUMMARY
                failed=1
              fi
            fi
          done

          if [ $failed -eq 1 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Some modules failed verification**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All modules verified**" >> $GITHUB_STEP_SUMMARY

      # Future: Call echidnabot API for enhanced verification
      # - name: Trigger ECHIDNA verification
      #   if: ${{ vars.ECHIDNA_ENABLED == 'true' }}
      #   env:
      #     ECHIDNABOT_URL: ${{ vars.ECHIDNABOT_URL }}
      #     ECHIDNABOT_TOKEN: ${{ secrets.ECHIDNABOT_TOKEN }}
      #   run: |
      #     curl -X POST "$ECHIDNABOT_URL/api/verify" \
      #       -H "Authorization: Bearer $ECHIDNABOT_TOKEN" \
      #       -H "Content-Type: application/json" \
      #       -d '{
      #         "repo": "${{ github.repository }}",
      #         "commit": "${{ github.sha }}",
      #         "prover": "idris2"
      #       }'
