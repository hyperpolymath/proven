# SPDX-License-Identifier: PMPL-1.0-or-later
name: Idris 2 CI

permissions: read-all

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'proven.ipkg'
      - '.github/workflows/idris2-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'proven.ipkg'
      - '.github/workflows/idris2-ci.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        idris2-version: ['0.7.0']

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Install Idris 2 dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chezscheme libgmp-dev

      - name: Cache Idris 2
        id: cache-idris2
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4
        with:
          path: |
            ~/.idris2
            ~/idris2-${{ matrix.idris2-version }}
          key: idris2-${{ matrix.idris2-version }}-${{ runner.os }}

      - name: Install Idris 2
        if: steps.cache-idris2.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch v${{ matrix.idris2-version }} https://github.com/idris-lang/Idris2.git ~/idris2-${{ matrix.idris2-version }}
          cd ~/idris2-${{ matrix.idris2-version }}
          make bootstrap SCHEME=chezscheme
          make install

      - name: Add Idris 2 to PATH
        run: echo "$HOME/.idris2/bin" >> $GITHUB_PATH

      - name: Build proven library
        run: idris2 --build proven.ipkg

      - name: Type check all modules
        run: |
          idris2 --check src/Proven.idr
          idris2 --check src/Proven/Core.idr
          idris2 --check src/Proven/SafeMath.idr
          idris2 --check src/Proven/SafeString.idr
          idris2 --check src/Proven/SafeJson.idr
          idris2 --check src/Proven/SafeUrl.idr
          idris2 --check src/Proven/SafeEmail.idr
          idris2 --check src/Proven/SafePath.idr
          idris2 --check src/Proven/SafeCrypto.idr
          idris2 --check src/Proven/SafePassword.idr
          idris2 --check src/Proven/SafeDateTime.idr
          idris2 --check src/Proven/SafeNetwork.idr

  docs:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Install Idris 2 dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chezscheme libgmp-dev

      - name: Cache Idris 2
        id: cache-idris2
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4
        with:
          path: |
            ~/.idris2
            ~/idris2-0.7.0
          key: idris2-0.7.0-${{ runner.os }}

      - name: Install Idris 2
        if: steps.cache-idris2.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch v0.7.0 https://github.com/idris-lang/Idris2.git ~/idris2-0.7.0
          cd ~/idris2-0.7.0
          make bootstrap SCHEME=chezscheme
          make install

      - name: Add Idris 2 to PATH
        run: echo "$HOME/.idris2/bin" >> $GITHUB_PATH

      - name: Generate documentation
        run: idris2 --mkdoc proven.ipkg || true

      - name: Upload docs artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: idris2-docs
          path: build/docs/
          if-no-files-found: ignore
